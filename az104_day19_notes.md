
# AZ-104 学习笔记 - Day 19

## 🗂 今日主题：Blob 生命周期管理与成本优化

---

## 📌 生命周期管理简介

Azure Storage 生命周期管理是一种自动化机制，可根据预定义规则在 Blob 数据上执行：
- 更改访问层（Hot → Cool → Archive）
- 自动删除过期数据
- 清理版本与快照

适合日志归档、备份保留、冷数据自动转层等场景。

---

## 🧱 生命周期策略结构

策略为 JSON 格式，包含多个规则。每条规则包括：

| 元素 | 描述 |
|------|------|
| `filters` | 指定 blob 类型、路径前缀等匹配条件 |
| `conditions` | 修改/访问时间间隔等条件（天数） |
| `actions` | 对 blob、版本或快照执行的操作（转层、删除等） |

### 示例操作

```json
{
  "actions": {
    "baseBlob": {
      "tierToCool": {
        "daysAfterModificationGreaterThan": 30
      },
      "delete": {
        "daysAfterModificationGreaterThan": 365
      }
    },
    "snapshot": {
      "delete": {
        "daysAfterCreationGreaterThan": 90
      }
    }
  }
}
```

---

## ⏱ 评估机制

- **执行频率**：每天自动评估一次所有 blob
- **作用对象**：仅支持 block blob（不支持 page/blob、append blob）
- **支持存储类型**：General Purpose v2 和 Blob Storage
- **不会自动从 Archive 恢复数据**，必须手动 rehydrate

---

## 💡 成本优化策略

| 方法 | 说明 |
|------|------|
| 生命周期规则转层 | 将不活跃数据转为 Cool/Archive 层 |
| 自动删除旧数据 | 日志/备份类数据按策略清除 |
| 细分容器结构 | 根据数据温度分开管理，利于访问层控制 |
| 开启存储分析 | 结合日志/指标评估热点和访问频率 |
| 避免误用版本控制 | 启用版本可能带来额外存储成本 |

---

## ⚠️ 常见误区

- 生命周期 **不会自动升级访问层**（如从 Archive 回 Hot）
- Archive 数据访问需先手动“解冻”（Rehydrate）
- 不支持 blob 重命名、压缩等高级处理
- 策略失效通常是路径/类型未匹配正确，建议测试验证

---

## 🌐 Azure、AWS、GCP 存储生命周期与成本优化对比

| 维度           | Azure Storage                                 | AWS Storage                                 | GCP Storage                                 |
|----------------|----------------------------------------------|---------------------------------------------|---------------------------------------------|
| 生命周期管理   | 支持生命周期管理策略（自动分层、归档、删除）  | 支持生命周期规则（分层、归档、删除、转移）   | 支持生命周期规则（分层、归档、删除、转移）   |
| 策略粒度       | 支持容器级、Blob 级                           | 支持桶级、对象级                            | 支持桶级、对象级                            |
| 自动分层       | 支持热/冷/存档自动切换                        | 支持 Standard/IA/Glacier 自动切换           | 支持 Standard/Nearline/Coldline/Archive 自动切换 |
| 归档管理       | 支持 Archive 层，需解冻                       | 支持 Glacier/Deep Archive，需解冻           | 支持 Archive，需解冻                        |
| 触发条件       | 基于对象最后访问/修改时间、存储天数等          | 基于对象年龄、上次访问、版本等              | 基于对象年龄、上次访问、自定义元数据等       |
| 成本优化建议   | 建议结合访问模式设置访问层和生命周期策略       | 建议启用智能分层、生命周期自动归档           | 建议使用多区域/冷存储并配置生命周期策略      |
| 费用透明度     | 提供成本分析工具（Cost Management + Advisor）  | 提供成本分析与预算工具（Cost Explorer）      | 提供成本分析与建议（Billing/Cost Management）|
| 计费模式       | 按存储层、访问次数、操作、数据传出计费         | 按存储层、访问次数、操作、数据传出计费       | 按存储层、访问次数、操作、数据传出计费       |

**总结：**
- 三大云厂商均支持灵活的生命周期管理和自动分层，帮助用户降低长期存储成本。
- 生命周期策略可自动将数据转为低成本存储层或归档，减少人工干预。
- 成本优化建议：结合访问频率、数据重要性和合规要求，合理配置生命周期和分层策略，并定期分析存储费
---

## ✅ 小测验回顾（4 / 5）

### 1. 生命周期策略可以完成哪些操作？
- ✅ B. 删除上传超过 30 天的文件

### 2. 生命周期策略**不支持**的操作？
- ✅ C. 自动压缩 blob（不支持）

### 3. 支持生命周期管理的 blob 类型？
- ✅ C. Block Blob

### 4. 生命周期策略的评估频率？
- ✅ C. 每日一次评估所有 blob

### 5. 降低长期存储成本的方式？
- ✅ A. 启用自动转层  
- ✅ B. 使用 Archive 层  
- ✅ D. 管理日志和备份数据  
- ❌ C. 启用版本控制 → 通常增加成本

---

## 📅 下一步预告 - Day 20

| 模块 | 内容 |
|------|------|
| Azure Files 共享 | SMB/NFS 文件存储 |
| Azure File Sync | 混合架构：本地 + 云 |
| NTFS ACL 权限继承 | 权限映射与限制 |
| 配额、性能、成本优化 | 使用场景与定价分析 |
