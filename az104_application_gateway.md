# Azure Application Gateway 后端池 VM 无法访问排查要点

在 Azure 应用网关 (Application Gateway) 部署中，如果后端池中的 VM 无法访问，除了题目中提到的 A（健康探测）、B（NSG 阻止流量）、C（监听器配置） 之外，还需要检查以下关键配置项：

---

## 可能被忽略的其他关键配置

### 后端池配置是否正确
- 确保后端池中已添加目标 VM 的正确 IP 地址或 NIC（如果是虚拟机规模集，需验证实例是否正常运行）。
- 检查后端端口是否与应用网关规则中定义的端口一致（默认是 HTTP 80 或 HTTPS 443）。

### HTTP 设置（HTTP Settings）
- 应用网关需要关联 HTTP 设置（定义协议、端口、会话亲和性等）。
- 常见问题：
  - 后端协议（HTTP/HTTPS）与 VM 上运行的服务不匹配。
  - 未配置自定义探测时，默认探测可能因路径（如 /）无响应而失败。

### 路由规则绑定
- 监听器必须与路由规则绑定，且规则需关联到正确的后端池和 HTTP 设置。
- 如果使用多站点监听器，需确保请求的 Host 头匹配监听器配置。

### 网络拓扑问题
- VNet 对等或连接问题：如果应用网关和后端 VM 位于不同 VNet，需确保 VNet 对等连接已正确配置且无流量限制。
- 子网隔离：应用网关必须部署在独立的子网中，且该子网不能有其他资源（如 VM、负载均衡器）。

### 证书问题（HTTPS 场景）
- 如果使用 HTTPS 监听器：
  - 后端证书是否有效且受信任（对于 HTTPS 后端）。
  - 是否配置了 SSL 终止或端到端 SSL 所需的证书。

### 平台级限制
- 检查 Azure 订阅配额是否足够（如应用网关实例数限制）。
- 确保应用网关的 SKU（如 Standard_v2）支持所需功能（如 Web 应用防火墙 WAF）。

---

## 排查工具与方法

### 应用网关诊断日志
- 启用并查看访问日志、性能日志、防火墙日志（Azure Monitor 或 Log Analytics）。
- 重点关注 HTTP 响应码（如 502 Bad Gateway 表示后端问题）。

### 手动测试后端可用性
- 从应用网关子网内的测试 VM 直接访问后端 IP 和端口，验证连通性：
  ```bash
  telnet <后端IP> 80
  curl -v http://<后端IP>
  ```

### NSG 和防火墙验证
- 确保后端 VM 的 NSG 允许来自应用网关子网 IP 范围的流量（Azure 文档会提供区域特定的 IP 范围）。
- 如果 VM 使用第三方防火墙（如 iptables），需额外放行流量。

---

## 总结

题目中的选项 D（以上所有）是正确的直接原因，但在实际场景中，还需系统性检查：

- ✅ 后端池成员状态
- ✅ HTTP 设置与探测配置
- ✅ 路由规则完整性
- ✅ 网络拓扑与安全规则
- ✅ 证书（HTTPS 场景）

建议通过 Azure 门户的应用网关诊断工具或 Network Watcher 进行端