
# AZ-104 学习笔记 - Day 21

## 📦 今日主题：Azure Files 快照与备份机制

---

## 🧩 Azure Files 快照（Snapshot）

| 项目 | 内容 |
|------|------|
| 类型 | 共享级快照（整个文件共享） |
| 特性 | 只读、按增量部分计费 |
| 恢复能力 | 可恢复已删除或更改的文件、目录 |
| 启动方式 | 手动触发，支持 Portal/CLI/PowerShell/Storage Explorer |
| 存储 | 占用共享本体容量（不额外分区） |

---

## 🛡️ Azure Backup for Azure Files

Azure Backup 提供对 Azure Files 的原生备份方案：

- **支持自动调度快照计划**
- **文件或文件夹级别还原**
- **最长 180 天快照保留**
- **与 Recovery Services Vault 结合管理**

> 适合日志、配置文件、文件服务器场景下的长期备份与恢复需求。

---

## 🔁 快照 vs Azure Backup 比较

| 比较项         | 快照                         | Azure Backup                         |
|----------------|------------------------------|--------------------------------------|
| 启动方式       | 手动                         | 自动调度                             |
| 管理位置       | 存储账户自身                 | Recovery Services Vault              |
| 恢复粒度       | 共享级（支持文件级还原）     | 文件 / 文件夹                        |
| 数据保留       | 手动删除                     | 备份策略设定                         |
| 成本           | 增量存储成本                 | 快照 + 管理成本                      |
| 使用前提       | GPv2/Premium 存储            | 同左，且需要配置 Backup Vault       |

---

## ⚠️ 常见问题与排查

| 问题              | 原因与建议 |
|-------------------|------------|
| 快照失败           | GPv1 类型不支持、权限不足、共享已满 |
| 恢复操作无效       | 用户权限不足、挂载时未启用版本快照 |
| 挂载失败           | NSG 或 Firewall 阻断 445 端口 |
| 无法启动备份       | 未配置 Backup Vault 或存储类型不支持 |
| 快照占用过多空间   | 定期清理旧快照，或使用生命周期策略 |
---

## 🌐 Azure、AWS、GCP 文件备份与快照机制对比

| 维度           | Azure                                    | AWS                                         | GCP                                         |
|----------------|------------------------------------------|---------------------------------------------|---------------------------------------------|
| 文件共享快照   | Azure Files 支持共享级快照，增量计费     | EFS 支持文件系统快照，支持自动/手动         | Filestore 支持文件共享快照（部分版本）      |
| 快照粒度       | 共享级（支持文件级还原）                 | 文件系统级（支持文件/目录级还原）           | 文件共享级（支持文件/目录级还原）           |
| 快照触发方式   | 手动、API、CLI、Portal                   | 手动、API、CLI、自动计划                    | 手动、API、CLI                              |
| 快照保留策略   | 手动删除或结合生命周期策略                | 支持生命周期管理、自动快照策略              | 支持快照保留、自动清理（部分版本）           |
| 备份服务       | Azure Backup for Azure Files，集成 Recovery Vault，支持自动调度、文件/文件夹级还原 | AWS Backup 支持 EFS/FSx，集中管理，自动调度、生命周期管理 | Backup for Filestore，自动/手动备份，集中管理 |
| 备份粒度       | 文件/文件夹级                            | 文件系统级、目录级                          | 文件共享级、目录级                          |
| 备份保留       | 最长 180 天（可策略设定）                 | 灵活设定，支持长期归档                      | 灵活设定，支持长期归档                      |
| 恢复方式       | Portal、PowerShell、Storage Explorer      | 控制台、CLI、API                            | 控制台、gcloud、API                         |
| 成本           | 快照按增量存储计费，备份按存储+管理计费   | 快照/备份按存储和操作计费                   | 快照/备份按存储和操作计费                   |

**总结：**
- 三大云厂商均支持文件共享快照和集中备份，支持自动调度、生命周期管理和细粒度恢复。
- Azure Files 快照和 Azure Backup 集成 Recovery Vault，AWS Backup 可统一管理 EFS/FSx 备份，GCP Filestore 支持快照和集中备份。
- 建议结合数据恢复需求、自动化程度和成本优化选择合适的快照与备份方

---

## ✅ 小测验回顾（2 / 5）

### 1. 关于快照描述正确的是？
- ✅ B. 快照可手动触发，增量存储计费

### 2. Azure Backup 与快照区别？
- ✅ A. Backup 支持自动调度
- ✅ D. Backup 支持文件夹级还原  
- ❌ B 错：快照无需 Recovery Vault  
- ❌ C 错：快照可恢复被删文件

### 3. 配置 Azure Backup 所需资源？
- ✅ A. Recovery Vault
- ✅ B. GPv2 或 Premium 存储
- ❌ C/D 错：生命周期管理、版本控制非前提

### 4. 不会导致快照失败的情况？
- ✅ D. 文件大（不限制）

### 5. 可用于快照恢复的方式？
- ✅ A. Azure Portal
- ✅ B. PowerShell
- ✅ C. Storage Explorer  
- ❌ D 错：本地 SMB 客户端右键恢复不适用于 Azure 快照

---

## 📅 下一步预告 - Day 22

| 模块 | 内容 |
|------|------|
| Azure Disk 管理与快照备份 | 操作系统盘 / 数据盘快照、还原策略 |
| VM 备份架构 | Recovery Vault + 还原点管理 |
| 与 Azure Backup 协同机制 | 快照 + Vault 长期备份 |

